version: '3.8'
services:
  unity_webgl_server:
    image: nginx:alpine
    volumes:
      - ./unity_webgl_server:/usr/share/nginx/html
      - ./unity_webgl_server/default.conf:/etc/nginx/conf.d/default.conf
    ports:
      - 8080:80


  controller:
    pid: "host"
    build:
      context: ./controller
    ports:
      - "$CONTROLLER_WEBSOCKET_PORT:$CONTROLLER_WEBSOCKET_PORT" # websocket
      - "$CONTROLLER_SERVER_PORT:$CONTROLLER_SERVER_PORT" # controller 
    volumes:
      - ./controller/src:/app/src
      - ./controller/pyproject.toml:/app/pyproject.toml
      - ./controller/pdm.lock:/app/pdm.lock
    # depends_on:
      # - firmware
    environment:
      - CONTROLLER_SERVER_HOST
      - CONTROLLER_SERVER_PORT  
      - TEST

  firmware:
    pid: "host"

    build:
      context: ./firmware
      dockerfile: Dockerfile
    volumes:
      - ./firmware/main:/app/main
      - ./firmware/CMakeLists.txt:/app/CMakeLists.txt
      - ./firmware/components:/app/components
    environment:
      - WIFI_SSID
      - WIFI_PASSWORD
      - CONTROLLER_SERVER_HOST
      - CONTROLLER_SERVER_PORT
  frontend:
      build: ./frontend
      volumes:
        - ./frontend/src:/app/src
        - ./frontend/package.json:/app/package.json
        - ./frontend/package-lock.json:/app/package-lock.json
        - ./frontend/tailwind.config.js:/app/tailwind.config.js
        - ./frontend/postcss.config.js:/app/postcss.config.js
      ports:
        - "3000:3000"
      environment:
        - NEXT_PUBLIC_BACKEND_URL

